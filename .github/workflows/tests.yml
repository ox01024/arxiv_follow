name: Tests and Quality Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      run: uv python install ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: uv sync --dev

    - name: Check code formatting with Black
      run: uv run black --check --diff src tests

    - name: Lint with Ruff
      run: uv run ruff check src tests

    - name: Type check with MyPy
      run: uv run mypy src
      continue-on-error: true  # MyPyæ£€æŸ¥å¯ä»¥å¤±è´¥ä½†ä¸é˜»å¡

  # åŸºç¡€æµ‹è¯•ï¼ˆå¿«é€Ÿåé¦ˆï¼‰
  test-basic:
    name: Basic Tests
    runs-on: ubuntu-latest
    needs: quality
    permissions:
      contents: read
    
    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      run: uv python install ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: uv sync --dev

    - name: Create necessary directories
      run: |
        mkdir -p reports
        mkdir -p data
        mkdir -p cache

    - name: Run CI environment tests
      run: uv run python tests/test_ci.py

    - name: Test package import
      run: |
        uv run python -c "import arxiv_follow; print(f'âœ… ArXiv Follow v{arxiv_follow.__version__} å¯¼å…¥æˆåŠŸ')"

    - name: Test CLI help
      run: uv run arxiv-follow --help

    - name: Test system connection
      run: uv run arxiv-follow test

  # å•å…ƒæµ‹è¯•
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: test-basic
    permissions:
      contents: read
    
    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      run: uv python install ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: uv sync --dev

    - name: Run unit tests
      env:
        OPEN_ROUTE_API_KEY: ${{ secrets.OPEN_ROUTE_API_KEY }}
        DIDA_ACCESS_TOKEN: ${{ secrets.DIDA_ACCESS_TOKEN }}
      run: |
        uv run pytest tests/ \
          -m "not integration and not slow" \
          --cov=src/arxiv_follow \
          --cov-report=xml \
          --cov-report=term-missing \
          --junit-xml=pytest-results.xml \
          -v

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
        flags: unittests
        name: codecov-${{ env.PYTHON_VERSION }}

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pytest-results-${{ env.PYTHON_VERSION }}
        path: pytest-results.xml

  # é›†æˆæµ‹è¯•ï¼ˆä»…åœ¨PRæ—¶è¿è¡Œï¼‰
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: test-unit
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
    
    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      run: uv python install ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: uv sync --dev

    - name: Run integration tests (with secrets if available)
      env:
        OPEN_ROUTE_API_KEY: ${{ secrets.OPEN_ROUTE_API_KEY }}
        DIDA_ACCESS_TOKEN: ${{ secrets.DIDA_ACCESS_TOKEN }}
      run: |
        # è¿è¡Œé›†æˆæµ‹è¯•ï¼Œä½†å…è®¸åœ¨æ²¡æœ‰APIå¯†é’¥æ—¶è·³è¿‡
        uv run pytest tests/ \
          -m "integration" \
          --tb=short \
          -v || echo "âš ï¸ é›†æˆæµ‹è¯•éƒ¨åˆ†å¤±è´¥ï¼ˆå¯èƒ½ç¼ºå°‘APIå¯†é’¥ï¼‰"

    - name: Test real ArXiv search (without API keys)
      run: |
        uv run arxiv-follow search "test query" --max 1 || echo "âš ï¸ ArXivæœç´¢æµ‹è¯•å¤±è´¥"

  # åŠŸèƒ½æµ‹è¯•ï¼ˆç«¯åˆ°ç«¯ï¼‰
  test-e2e:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: test-unit
    permissions:
      contents: read
    
    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      run: uv python install ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: uv sync

    - name: Test CLI commands
      run: |
        echo "ğŸ§ª æµ‹è¯•CLIå‘½ä»¤..."
        
        # æµ‹è¯•å¸®åŠ©å‘½ä»¤
        uv run arxiv-follow --help
        uv run arxiv-follow search --help
        uv run arxiv-follow recent --help
        
        # æµ‹è¯•é…ç½®æ˜¾ç¤º
        uv run arxiv-follow config
        
        # æµ‹è¯•æœç´¢åŠŸèƒ½ï¼ˆå°é‡æ•°æ®ï¼‰
        uv run arxiv-follow search "machine learning" --max 2
        
        echo "âœ… CLIæµ‹è¯•é€šè¿‡"

    - name: Test Python package interface
      run: |
        echo "ğŸ§ª æµ‹è¯•PythonåŒ…æ¥å£..."
        
        uv run python -c "
        import arxiv_follow
        
        # æµ‹è¯•å¿«é€Ÿæœç´¢
        result = arxiv_follow.quick_search('neural networks', max_results=2)
        print(f'âœ… å¿«é€Ÿæœç´¢: æ‰¾åˆ° {result[\"count\"]} ç¯‡è®ºæ–‡')
        
        # æµ‹è¯•é…ç½®åŠ è½½
        config = arxiv_follow.load_config()
        print(f'âœ… é…ç½®åŠ è½½: {config.app_name} v{config.app_version}')
        
        print('âœ… PythonåŒ…æ¥å£æµ‹è¯•é€šè¿‡')
        "

  # æ€§èƒ½æµ‹è¯•ï¼ˆä»…åœ¨ä¸»åˆ†æ”¯ï¼‰
  test-performance:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: test-unit
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      run: uv python install ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: uv sync

    - name: Run performance tests
      run: |
        echo "ğŸš€ è¿è¡Œæ€§èƒ½æµ‹è¯•..."
        
        # æµ‹è¯•å¤§é‡æœç´¢çš„æ€§èƒ½
        time uv run arxiv-follow search "deep learning" --max 50
        
        # æµ‹è¯•åŒ…å¯¼å…¥æ—¶é—´
        time uv run python -c "import arxiv_follow; print('åŒ…å¯¼å…¥å®Œæˆ')"
        
        echo "âœ… æ€§èƒ½æµ‹è¯•å®Œæˆ"

  # æ±‡æ€»æ‰€æœ‰æµ‹è¯•ç»“æœ
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [quality, test-basic, test-unit, test-e2e]
    if: always()
    
    steps:
    - name: Check test results
      run: |
        echo "ğŸ“Š æµ‹è¯•æ±‡æ€»ç»“æœ:"
        echo "- ä»£ç è´¨é‡æ£€æŸ¥: ${{ needs.quality.result }}"
        echo "- åŸºç¡€æµ‹è¯•: ${{ needs.test-basic.result }}"
        echo "- å•å…ƒæµ‹è¯•: ${{ needs.test-unit.result }}"
        echo "- ç«¯åˆ°ç«¯æµ‹è¯•: ${{ needs.test-e2e.result }}"
        
        if [[ "${{ needs.quality.result }}" == "success" && \
              "${{ needs.test-basic.result }}" == "success" && \
              "${{ needs.test-unit.result }}" == "success" && \
              "${{ needs.test-e2e.result }}" == "success" ]]; then
          echo "ğŸ‰ æ‰€æœ‰æ ¸å¿ƒæµ‹è¯•é€šè¿‡ï¼"
        else
          echo "âŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥"
          exit 1
        fi 