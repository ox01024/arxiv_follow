name: ğŸ“„ æ¯æ—¥ç ”ç©¶è€…åŠ¨æ€ç›‘æ§

on:
  # å®šæ—¶æ‰§è¡Œ - ä¸­å›½æ—¶é—´ 9:00, 12:00, 22:00 (å¯¹åº”UTC 1:00, 4:00, 14:00)
  schedule:
    - cron: '0 1 * * *'   # ä¸­å›½æ—¶é—´ 09:00
    - cron: '0 4 * * *'   # ä¸­å›½æ—¶é—´ 12:00  
    - cron: '0 14 * * *'  # ä¸­å›½æ—¶é—´ 22:00
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # æ¨é€åˆ°mainåˆ†æ”¯æ—¶ä¹Ÿè§¦å‘ï¼ˆç”¨äºæµ‹è¯•ï¼‰
  push:
    branches: [ main ]
    paths: 
      - 'src/arxiv_follow/cli/daily.py'
      - '.github/workflows/daily_papers.yml'

jobs:
  daily-monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ å®‰è£… UV åŒ…ç®¡ç†å™¨
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
    
    - name: âš¡ å®‰è£…ä¾èµ–
      run: |
        uv sync
    
    - name: ğŸ§ª ç¯å¢ƒæµ‹è¯•
      run: |
        uv run python tests/test_ci.py
    
    - name: ğŸ” è¿è¡Œæ¯æ—¥ç ”ç©¶è€…åŠ¨æ€ç›‘æ§
      run: |
        echo "ğŸ• å½“å‰æ—¶é—´ (UTC): $(date)"
        echo "ğŸ•˜ åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date)"
        echo "=========================================="
        uv run python -m arxiv_follow.cli.daily
      env:
        TZ: Asia/Shanghai  # è®¾ç½®æ—¶åŒºä¸ºä¸­å›½æ—¶é—´
        DIDA_ACCESS_TOKEN: ${{ secrets.DIDA_ACCESS_TOKEN }}
        OPEN_ROUTE_API_KEY: ${{ secrets.OPEN_ROUTE_API_KEY }}
    
    - name: ğŸ“Š ä¿å­˜è¿è¡Œæ—¥å¿—
      if: always()
      run: |
        mkdir -p logs
        echo "è¿è¡Œæ—¶é—´: $(TZ='Asia/Shanghai' date)" > logs/daily_$(date +%Y%m%d_%H%M).log
        echo "è„šæœ¬: daily_papers.py" >> logs/daily_$(date +%Y%m%d_%H%M).log
        
    - name: ğŸ“ ä¸Šä¼ è¿è¡Œæ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: daily-logs-${{ github.run_number }}
        path: logs/
        retention-days: 30 